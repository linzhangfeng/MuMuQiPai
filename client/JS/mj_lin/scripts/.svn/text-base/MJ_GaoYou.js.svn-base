loadProtoFile("proto/gaoyougameproto.proto");


var HuType = {
    HU_INVALID: 0,
    HU_ZIMO: 1,
    HU_PAOHU: 2,
    HU_HeiMo: 2,
    Hu_RuanMo: 1,
    HU_DIANPAO: 3,
    HU_BEIZIMO: 4,
    HU_QIANG_GANG: 5,
    HU_BEI_QIANG_GANG: 6,
    HU_YI_PAO_DUO_XIANG: 7,
    HU_GANG_SHANG_HUA: 8,
    HU_GANG_HOU_PAO: 9,
};

var AddFanTypeArray = {
    0: "对对胡",
    1: "七对",
    2: "双七对",
    3: "双双七对",
    4: "三炸七对",
    5: "混一色",
    6: "清一色",
    7: "小三风",
    8: "大三风",
    9: "门清",
    10: "无花果",
    11: "杠上开花",
    12: "三招",
    13: "四招",
    14: "平胡",
    15: "一条龙",
    16: "大吊车",
    17: "趴牌",
    18: "四搭"
};


var selfCMD = {
    SERVER_Laizi_BC: 5029,   //亮牌
    CLIENT_ROBOT_REQ: 1008,  //
    SERVER_ROBOT_SER: 4117,
    SERVER_CHANGE_CARD: 5009,
    SERVER_CHANGE_CARD_NEW: 5800,
};

var PZHActionType =
{
    TYPE_LiangPai: 0x4000,//唱歌
};

var MJTable_GaoYou = MJTable.extend({
    tag: "MJTable_GaoYou",
    _curLaizi: -1,
    _curLaizipi: -1,
    _curLaizipi2: -1,
    _curLaizi_bg: null,
    isRecordShow: false,
    _pkg_id: 0,
    maxQuan: 1,
    _tuoguanBtn: null,
    _tuoguanFlag: [null, null, null, null],
    ctor: function () {
        this._super();
    },
    initRoom: function () {
        MJModel.mj_suport_fangyan = 1;
        MJModel.outCardEffect_style = 1;

        MJModel.mj_bg_use = 1;
        MJModel.mj_suport_change_bg = 1;
        MJModel.toupiaoTipsType = 1;
        MJModel.chi_layout = 3;
        MJModel.mj_touch_tip = 1;
        MJModel.isOutCard = true;
        MJModel.mj_chat_style = 5;
        MJModel.mj_public_style = 1;
        MJModel.mj_card_lib_type = 1;

        MJModel.mj_gps_type = 1;
        MJModel.mj_double_click_style = 1;

        MJModel.mj_font = "jianjie";
        MJModel.mj_fontSize = "dahao";
        MJModel.mj_style = "shishang";
        MJModel.yinyue = "jingdian";

        try {
            var roomData = JSON.parse(ZJHModel.getInstance().getRoomData());
            this._pkg_id = roomData["gameRoom"]["pkgId"];
        } catch (e) {
            Log(this, e);
        }

        try {
            var help = this.roomPublic.getChildByName("game_help");
            help.setVisible(false);
        } catch (e) {

        }

        this._init_extend();
        this._super();
        MJModel.mj_paiban = "horizontal";
        this._update_action();
        this._init_ui();
        //this.schedule(this.test, 1.0);
    },
    _init_ui: function () {
        var self = this;
        {
            var btn = new ccui.Button();
            btn.loadTextures(getResPath("gaoyou/action/baoting1.png"), getResPath("gaoyou/action/baoting2.png"), "");
            this.room_Action.actions["liang"] = btn;
            btn.setName("liang");
            btn.addClickEventListener(function (sender, evt) {
                self.room_Action.btnCallback(sender);
            });
            btn.setVisible(false);
            this.room_Action.addChild(btn);
            this.room_Action.opBtns.push(btn);
        }

        var super_setOperator = MJAction.prototype.setOperator;
        MJAction.prototype.setOperator = function (operat) {
            this.removeChildByName("ChooseGang_selectLayer");
            if (operat != -1 && (operat & PZHActionType.TYPE_LiangPai) == PZHActionType.TYPE_LiangPai) {
                if (this.actions["liang"]) {
                    this.actions["liang"].setVisible(true);
                }
            }
            super_setOperator.call(this, operat);
            if (operat != -1 && (operat & ActionType.TYPE_HU) == ActionType.TYPE_HU && self.room_Card.isDuoPai(0) && MJModel.mj_mo_cards[0] == self._curLaizi) {
                var showpass = true;
                if (MJModel.mj_lockcard_type == 2) {
                    showpass = false;
                } else {
                    var isalllaizi = true;
                    for (var i = 0; i < self.room_Card.hand_card[0].length; i++) {
                        var card = self.room_Card.hand_card[0][i];
                        if (card.getValue() != self._curLaizi) {
                            isalllaizi = false;
                            break;
                        }
                    }
                    if (isalllaizi)showpass = false;
                }
                if (!showpass && this.actions["pass"]) {
                    this.actions["pass"].setVisible(false);
                    this.reflashOpBtns();
                }
            }
        };

        var super_btnCallback = MJAction.prototype.btnCallback;
        MJAction.prototype.btnCallback = function (ref) {
            var n = ref;
            var name = n.getName();
            Log(this, "btnCallback:" + name);
            if (name == "liang") {
                this.setOperator(-1);
                MJModel.isLiangPai = 1;
                MJModel.mj_lockcard_type = 1;
                self.myselfOpenOutCard();
                self.room_Card.setSomeCardClickState();
                return;
            }
            super_btnCallback.call(this, ref);
        };
    },
    _update_action: function () {
        this.room_Action.actions["pass"].loadTextures(getResPath("gaoyou/action/pass1.png"), getResPath("gaoyou/action/pass2.png"), getResPath("gaoyou/action/pass2.png"));

        this.room_Action.actions["chi"].loadTextures(getResPath("gaoyou/action/chi1.png"), getResPath("gaoyou/action/chi2.png"), getResPath("gaoyou/action/pass2.png"));

        this.room_Action.actions["peng"].loadTextures(getResPath("gaoyou/action/peng1.png"), getResPath("gaoyou/action/peng2.png"), getResPath("gaoyou/action/pass2.png"));

        this.room_Action.actions["gang"].loadTextures(getResPath("gaoyou/action/gang1.png"), getResPath("gaoyou/action/gang2.png"), getResPath("gaoyou/action/pass2.png"));

        this.room_Action.actions["hu"].loadTextures(getResPath("gaoyou/action/hu1.png"), getResPath("gaoyou/action/hu2.png"), getResPath("gaoyou/action/pass2.png"));

        this.room_Action.opBtns = [];
        this.room_Action.opBtns.push(this.room_Action.actions["pass"]);
        this.room_Action.opBtns.push(this.room_Action.actions["chi"]);
        this.room_Action.opBtns.push(this.room_Action.actions["peng"]);
        this.room_Action.opBtns.push(this.room_Action.actions["gang"]);
        this.room_Action.opBtns.push(this.room_Action.actions["hu"]);

        var size = cc.director.getWinSize();
        var self = this;
        if (this._tuoguanBtn == null) {
            this._tuoguanBtn = new ccui.Button();
            this._tuoguanBtn.loadTextures(getResPath("gaoyou/action/quxiaotuoguan1.png"), "gaoyou/action/quxiaotuoguan2", "");
            this._tuoguanBtn.setPosition(cc.p(size.width - 184 - 92 - 90, 200));
            this._tuoguanBtn.setName("quxiaotuoguan");
            this._tuoguanBtn.addClickEventListener(function (sender, evt) {
                sendQuxiaoTuoguan();
            });
            this._tuoguanBtn.setVisible(false);
            this.addChild(this._tuoguanBtn, 100);
        }

        for (var i = 0; i < this._tuoguanFlag.length; i++) {
            this._tuoguanFlag[i] = new cc.Sprite(getResPath("gaoyou/flag/tuoguan.png"));
            this._tuoguanFlag[i].setVisible(false);
            if (i == 0) {
                this._tuoguanFlag[i].setPosition(cc.p(size.width / 2, 150));
            } else if (i == 2) {
                this._tuoguanFlag[i].setPosition(cc.p(size.width / 2, size.height - 80));
            } else if (i == 1) {
                this._tuoguanFlag[i].setPosition(cc.p(size.width - 150, size.height / 2));
            } else if (i == 3) {
                this._tuoguanFlag[i].setPosition(cc.p(150, size.height / 2));
            }
            this.addChild(this._tuoguanFlag[i], 100);
        }
    },
    getMjTypePath: function () {
        return getResPath("gaoyou/mj_type_1033.png");
    },

    updateBg: function (isInit) {
        if (isInit == undefined)isInit = false;
        var size = cc.director.getWinSize();
        if (this.bg == null) {
            this.bg = new ccui.ImageView(getResPath(this.getBgStr()));
            this.bg.setAnchorPoint(cc.p(0.5, 0.5));
            this.bg.setContentSize(size);
            this.bg.setScale9Enabled(true);
            this.bg.setPosition(size.width / 2, size.height / 2);
            this.addChild(this.bg, -100);
        } else {
            this.bg.loadTexture(getResPath(this.getBgStr()));
        }
        //简洁版本的幺鸡牌换了
        if (MJModel.mj_font == "jianjie") {
            Utils.addCardSprites(__String.createWithFormat("gaoyou/cards/%1_%2_%3_debug", MJModel.mj_font, MJModel.mj_fontSize, MJModel.mj_table_view));
        } else {
            Utils.addCardSprites(__String.createWithFormat("RoomMJ/cards/%1_%2_%3_debug", MJModel.mj_font, MJModel.mj_fontSize, MJModel.mj_table_view));
        }
        this.loadCardConfig();
        if (isInit)return;

        this.room_Card.reflashAllCardUI();
        for (var i = 0; i < 4; i++) {
            this.players[i].setPosition(MJConfig.getPlayerPos(i));
            this.players[i].reflashNameMoneyPosition();
        }
        if (this.room_Info)this.room_Info.reflash();
    },
    loadCardConfig: function (path) {
        this._super(MJModel.mj_bg_use == 0 ? "gaoyou/config/card_config_gaoyou.json" : "gaoyou/config/card_config2d_gaoyou.json");
    },

    isSupportPublicCard: function () {
        return false;
    },

    _init_extend: function () {
        var self_table = this;
        MJCards.prototype.clickHandCardCallback = function (n) {
            if (MJModel.canTouchCard == false) {
                return;
            }
            var card = n;
            if (MJModel.canChoiceMore) {
                this.doChoiceMoreCard(card);
                return;
            }

            var preCard = null;

            for (var i = 0; i < this.hand_card[0].length; i++) {
                var fcard = this.hand_card[0][i];
                if (fcard) {
                    if (fcard.isUp) preCard = fcard;
                    fcard.setUp(false);
                }
            }

            if (this.outCardBtn) this.outCardBtn.setVisible(false);

            if (preCard && preCard == card) {
                if (MJModel.mj_double_click_style == 1)this.outHandCardCallback(n);
                return;
            }

            card.setUp(true);

            var hasTingPaiInfo = false;

            try {
                MJModel.mj_table.room_Tip.hideOutCardTip();
                MJModel.mj_table.removeChildByName("tingpai_layer");
                var listen_info = MJModel.listen_info;
                cc.log("listen:" + JSON.stringify(MJModel.listen_info2));
                if (MJModel.mj_lockcard_type == 1)listen_info = MJModel.listen_info2;
                for (var i = 0; i < listen_info.length; i++) {
                    var tli = listen_info[i];
                    if (card.getValue() == tli.OutCard) {
                        var can_show_listen_info = true;
                        for (var j = 0; j < tli.HuInfo.length; j++) {
                            if (tli.HuInfo[j].Card == 255) {
                                can_show_listen_info = false;
                                break;
                            }
                        }

                        if (can_show_listen_info) {
                            MJModel.mj_listenLayer_autoshow = false;
                            var curTingPaiLayer = new TingPaiLayer();
                            curTingPaiLayer.show2(tli.HuInfo);

                            curTingPaiLayer.setName("tingpai_layer");
                            MJModel.mj_table.addChild(curTingPaiLayer, 100);
                            hasTingPaiInfo = true;
                        } else {
                            PlatformHelper.showToast("见字胡不显示听牌张");
                        }
                        break;
                    }
                }
            } catch (e) {
                Log(this, e);
            }


            if (this.outCardBtn == null) {
                this.createOutCardBtn();
            }
            else {
                this.outCardBtn.setVisible(true);
            }

            if (this.outCardBtn) {
                var size = cc.director.getWinSize();
                this.outCardBtn.setPosition(cc.p(size.width - 120, 189));
                //if (hasTingPaiInfo && card.getPositionX() > size.width - 318) {
                //    this.outCardBtn.setPosition(cc.p(size.width - 168, 340 + 50));
                //}
                //else {
                //    this.outCardBtn.setPosition(cc.p(size.width - 168, 189));
                //}
            }
        };

        var supersetValue = MJPeng.prototype.setValue;
        MJPeng.prototype.setValue = function (type, pos, value, index, out_pos, isEnd, OpType) {
            supersetValue.call(this, type, pos, value, index, out_pos, isEnd, OpType);
            //类型暗杠，并且是癞晃，并且value是癞子皮
            if (value == self_table._curLaizipi && this.cardList[3] && type == PengType.Peng_AnKang) {
                this.cardList[1].setVisible(false);
                if (this.cardList[3]) {
                    this.cardList[3].setPosition(this.cardList[1].getPosition());
                    this.cardList[3].setZOrder(this.cardList[1].getZOrder());
                }
            }
        };

        var spuer_MJPreTable_ctor = MJPreTable.prototype.ctor;
        MJPreTable.prototype.ctor = function () {
            spuer_MJPreTable_ctor.call(this);
            var self = this;
            var wx_share = this.btns["yaoqing"];
            var xl_share = this.btns["xlshare"];
            var copy = this.btns["copyshare"];
            var ready = this.btns["ready"];
            xl_share.setVisible(false);
            var parent = wx_share.getParent();
            wx_share.removeFromParent();
            copy.removeFromParent();

            wx_share = new ccui.Button();
            wx_share.loadTextures(getResPath("RoomMJ/mj_public/common/pretable/share1.png"), getResPath("RoomMJ/mj_public/common/pretable/share2.png"), "");
            parent.addChild(wx_share);
            wx_share.setName("yaoqing");
            wx_share.addClickEventListener(function (sender, evt) {
                self.actionCallBack(sender);
            });
            this.btns[wx_share.getName()] = wx_share;

            copy = new ccui.Button();
            copy.loadTextures(getResPath("RoomMJ/mj_public/common/pretable/copy1.png"), getResPath("RoomMJ/mj_public/common/pretable/copy2.png"), "");
            parent.addChild(copy);
            copy.setName("copyshare");
            copy.addClickEventListener(function (sender, evt) {
                self.actionCallBack(sender);
            });
            this.btns[copy.getName()] = copy;

            wx_share.setPosition(-310, ready.getPositionY());
            copy.setPosition(310, ready.getPositionY());
        };

        var spuer_CommonTotalResult_ctor = CommonTotalResult.prototype.ctor;
        CommonTotalResult.prototype.ctor = function () {
            spuer_CommonTotalResult_ctor.call(this);
            var self = this;
            var wx_share = this.btns["share"];
            var xl_share = this.btns["xlshare"];
            var copy = this.btns["copy"];
            xl_share.setVisible(false);

            var parent = wx_share.getParent();
            wx_share.removeFromParent();
            copy.removeFromParent();

            wx_share = new ccui.Button();
            wx_share.loadTextures(getResPath("RoomMJ/mj_public/common/dialog/bigresult/share1.png"), getResPath("RoomMJ/mj_public/common/dialog/bigresult/share2.png"), "");
            parent.addChild(wx_share);
            wx_share.setName("share");
            wx_share.addClickEventListener(function (sender, evt) {
                self.actionCallBack(sender);
            });
            this.btns[wx_share.getName()] = wx_share;

            copy = new ccui.Button();
            copy.loadTextures(getResPath("RoomMJ/mj_public/common/dialog/bigresult/copy_btn1.png"), getResPath("RoomMJ/mj_public/common/dialog/bigresult/copy_btn2.png"), "");
            parent.addChild(copy);
            copy.setName("copy");
            copy.addClickEventListener(function (sender, evt) {
                self.actionCallBack(sender);
            });
            this.btns[copy.getName()] = copy;

            var size = cc.director.getWinSize();
            wx_share.setPosition(size.width / 2, 48);
            copy.setPosition(size.width / 2 + wx_share.getContentSize().width / 2 + copy.getContentSize().width / 2 + 10, wx_share.getPositionY() + 8);

            var sharelinks = new ccui.Button(getResPath("gaoyou/action/sharelinks1.png"), getResPath("gaoyou/action/sharelinks2.png"), getResPath("gaoyou/action/sharelinks2.png"));
            sharelinks.setPosition(cc.p(size.width / 2 - wx_share.getContentSize().width / 2 - sharelinks.getContentSize().width / 2 - 10, wx_share.getPositionY()));
            sharelinks.setName("sharelinks");
            sharelinks.addClickEventListener(function (sender, evt) {
                Utils.shareLinksToWX();
                sharelinks.setEnabled(false);
            });
            parent.addChild(sharelinks);

            var jushu = this.rootNode.getChildByName("jushu");
            jushu.setPositionX(jushu.getPositionX() - 30);
        };

        MJPlayer.prototype.setLiangPaiVisible = function (v) {
            if (!this.liangpai_flag) {
                this.liangpai_flag = new cc.Sprite(getResPath("gaoyou/flag/ting_tip.png"));
                this.liangpai_flag.setVisible(false);
                if (this.pid == 1) {
                    this.liangpai_flag.setPosition(cc.p(0, 30));
                }
                else {
                    this.liangpai_flag.setPosition(cc.p(this.m_size.width, 30));
                }
                this.addChild(this.liangpai_flag);
            }
            if (this.liangpai_flag) {
                this.liangpai_flag.setVisible(v);
            }
        };

        var superreset = MJPlayer.prototype.reset;
        MJPlayer.prototype.reset = function (allClean, isGameStart) {
            superreset.call(this);
            this.setLiangPaiVisible(false);
        };

        var super_setSomeCardClickState = MJCards.prototype.setSomeCardClickState;
        MJCards.prototype.setSomeCardClickState = function () {
            if (MJModel.mj_lockcard_type == 2) {
                super_setSomeCardClickState.call(this);
            } else if (MJModel.mj_lockcard_type == 1) {
                var listen_cards = [];
                for (var i = 0; i < MJModel.listen_info2.length; i++) {
                    var lsi = MJModel.listen_info2[i];
                    listen_cards.push(lsi.OutCard);
                }

                for (var i = 0; i < this.hand_card[0].length; i++) {
                    var card = this.hand_card[0][i];
                    if (listen_cards.indexOf(card.getValue()) == -1) {
                        card.setBlackVis(true);
                        card.setCardTouchEnable(false);
                    }
                }
            }

            var have_cardout = false;
            for (var i = 0; i < this.hand_card[0].length; i++) {
                var card = this.hand_card[0][i];
                if (card.getValue() == self_table._curLaizi) {
                    card.setBlackVis(true);
                    card.setCardTouchEnable(false);
                } else if (card.isCardTouch == true) {
                    have_cardout = true;
                }
            }

            if (have_cardout == false) {
                for (var i = 0; i < this.hand_card[0].length; i++) {
                    var card = this.hand_card[0][i];
                    card.setBlackVis(false);
                    card.setCardTouchEnable(true);
                }
            }
        };

        Setting.prototype.showPaiBanView = function (is) {
            is = false;
            this._gameSettingLayer.getChildByName("light_title").setVisible(is);
            this.checkboxs_gamesetting["paiban_horizontal"].setVisible(is);
            this.checkboxs_gamesetting["paiban_vertical"].setVisible(is);
        };

        var super_addOutCard = MJCards.prototype.addOutCard;
        MJCards.prototype.addOutCard = function (pos, value, showPoint) {
            if (self_table._isHuaPai(value)) {
                return this.addHuCard(pos, value);
            }
            else {
                return super_addOutCard.call(this, pos, value, showPoint);
            }
        };

        MJConfig.getHuCardPos = function (pos, index) {
            return this.getWorldPosition("hu_" + pos, "h_" + index);
        };

        MJConfig.getHuCardOrder = function (pos, index) {
            if (MJModel.mj_bg_use == 0) {
                var order = [
                    [
                        50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50,
                    ],
                    [
                        9, 8, 7, 6, 5, 4, 3, 2, 1, 0, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10,
                    ],
                    [
                        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                    ],
                    [
                        0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19,
                    ],
                ];
                return order[pos][index];
            }
            var order = [
                [
                    50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50,
                ],
                [
                    19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0,
                ],
                [
                    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                ],
                [
                    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19,
                ],
            ];
            return order[pos][index];
        };

        var super_getCardStr_new = MJConfig.getCardStr_new;
        MJConfig.getCardStr_new = function (value, pos, type, index) {
            if (type == CardType.Card_Hu && (pos == 1 || pos == 3) && MJModel.mj_bg_use == 0) {
                return super_getCardStr_new.call(this, value, pos, CardType.Card_End, index);
            } else {
                return super_getCardStr_new.call(this, value, pos, type, index);
            }
        };

        MJCards.prototype.sortCard = function (a, b) {
            return self_table._sortCard(a, b);
        };

        MJCard.prototype.check_addFlag = function () {
            self_table._checkAddCardFlag(this);
        };

        //湖北麻将不要自动胡牌功能
        MJAction.prototype.setAutoOutCardVis = function (value) {
        };

        Setting.prototype.doSupportFangYan = function () {
            this.checkboxs_setting["fangyan_putonghua"].setVisible(true);
            this.checkboxs_setting["fangyan_fangyan1"].setVisible(true);
            this.checkboxs_setting["fangyan_fangyan2"].setVisible(false);

            this.checkboxs_setting["fangyan_fangyan1"].getChildByName("text").setString("方言");
            this.checkboxs_setting["fangyan_fangyan1"].getChildByName("text").ignoreContentAdaptWithSize(true);

            this.checkboxs_setting["fangyan_fangyan2"].getChildByName("text").setString("方言2");
            this.checkboxs_setting["fangyan_fangyan2"].getChildByName("text").ignoreContentAdaptWithSize(true);
        };

        //去掉出牌按钮
        MJCards.prototype.createOutCardBtn = function () {

        };

        MJCard.prototype.createTingFlag = function () {
            if (this.tingpai_flag) {
                try {
                    this.tingpai_flag.removeFromParent(true);
                } catch (e) {

                }

                this.tingpai_flag = null;
            }

            var m_size = this.getContentSize();
            this.tingpai_flag = new cc.Sprite(getResPath("gaoyou/flag/ting.png"));
            this.tingpai_flag.setAnchorPoint(cc.p(0.5, 0));
            this.tingpai_flag.setPosition(cc.p(m_size.width / 2, m_size.height - 23));
            this.tingpai_flag.setVisible(false);
            this.addChild(this.tingpai_flag);
        };

        BigFaceMenu.prototype.getIconsIndexArray = function (seatid) {
            var icons = [1, 3, 7, 8, 18, 19];//需要显示的动画表情
            return icons;
        };

        //不同城市也要显示距离
        PlayerInfo.prototype.updateInfo = function () {
            var hasnocity = false;
            var hastoonear = false;
            var playerNums = 4;
            if (MJModel.mj_roomType == 1) {
                playerNums = 3;
            } else if (MJModel.mj_roomType == 2) {
                playerNums = 2;
            }
            for (var i = 0; i < playerNums; i++) {
                var player = MJModel.players[i];
                var playerData = this.getPlayerData(player.uid);
                var pos = MJModel.getPosBySeatid(i);
                var playerUI = this.players.getChildByName("player" + pos);
                var avatar = playerUI.getChildByName("avatar");
                var name = playerUI.getChildByName("name");
                var city = playerUI.getChildByName("city");
                city.stopAllActions();
                avatar.removeAllChildren();
                name.setString("");
                name.ignoreContentAdaptWithSize(true);

                city.setString("");
                city.ignoreContentAdaptWithSize(true);
                if (player.uid <= 0) {
                    city.setString("");
                    var m_pAvatar = new cc.Sprite("Avatars/user4_unlogin.png");
                    m_pAvatar.setScale(85 / m_pAvatar.getContentSize().width, 85 / m_pAvatar.getContentSize().height);
                    avatar.addChild(m_pAvatar);
                } else {
                    var m_pAvatar = Utils.createCircleAvatar(player.avatar, "Avatars/user4_unlogin.png", "Avatars/user4_unlogin.png", cc.size(85, 85));
                    avatar.addChild(m_pAvatar);
                    name.setString(player.name);
                    //city.setColor(cc.color(255, 255, 255));
                    if (this.isNoData(playerData)) {
                        hasnocity = true;
                        //city.setColor(cc.color(255, 0, 0));
                        city.setString("未检测到位置");
                        //city.runAction(cc.sequence(cc.moveBy(0.5, cc.p(0, 5)), cc.moveBy(0.5, cc.p(0, -5))).repeatForever());
                    } else {
                        city.setString(Utils.parseName(10, playerData.city));
                    }
                }
            }
            var cs = this.julitips.getChildren();
            for (var i in cs) {
                var tips = cs[i];
                if (!tips)continue;
                var name = tips.getName();
                var ps = name.split("_");
                var label = tips.getChildByName("num");
                var s1 = MJModel.getSeatidByPos(parseInt(ps[0]));
                var s2 = MJModel.getSeatidByPos(parseInt(ps[1]));
                var p1 = MJModel.players[s1];
                var p2 = MJModel.players[s2];

                tips.getChildByName("hong").setVisible(false);
                tips.getChildByName("lv").setVisible(false);
                tips.getChildByName("hong").setScaleX(1);
                tips.getChildByName("lv").setScaleX(1);
                tips.getChildByName("hong").stopAllActions();
                tips.getChildByName("lv").stopAllActions();
                label.setString("");
                label.ignoreContentAdaptWithSize(true);

                if (!p1 || !p2 || p1.uid <= 0 || p2.uid <= 0) {
                    continue;
                }

                var playerData1 = this.getPlayerData(p1.uid);
                var playerData2 = this.getPlayerData(p2.uid);

                if (this.isNoData(playerData1)) {
                    continue;
                }

                if (this.isNoData(playerData2)) {
                    continue;
                }

                // if (playerData1.city != playerData2.city) {
                //     continue;
                // }

                var dis = Utils.getDistance(playerData1.latitude, playerData1.longitude, playerData2.latitude, playerData2.longitude);
                tips.setVisible(true);
                if (dis >= 1000) {
                    var tip = tips.getChildByName("lv");
                    tip.setVisible(true);
                    var dis_f = parseFloat(dis / 1000);
                    label.setString(dis_f.toFixed(1) + "千米");
                    tip.setScaleX((label.getContentSize().width + 20) / tip.getContentSize().width);
                    label.setScaleX(1 / tip.getScaleX());
                } else {
                    label.setString(dis + "米");
                }

                if (dis <= 100) {
                    tips.getChildByName("hong").setVisible(true);
                    //tip.runAction(cc.sequence(cc.moveBy(0.5, cc.p(0, 5)), cc.moveBy(0.5, cc.p(0, -5))).repeatForever());
                    hastoonear = true;
                } else {
                    tips.getChildByName("lv").setVisible(true);
                }
            }

            this.warningTip.setVisible(false);
            this.btns["jieshan"].setVisible(false);
            this.btns["continue"].setVisible(false);
            this.warningTip.stopAllActions();
            if (hasnocity || hastoonear) {
                this.warningTip.setVisible(true);
                this.btns["jieshan"].setVisible(true);
                this.btns["continue"].setVisible(true);
                this.warningTip.runAction(cc.sequence(cc.delayTime(1), cc.hide(), cc.delayTime(0.1), cc.show()).repeatForever());
                this.warningTip.ignoreContentAdaptWithSize(true);
                if (hasnocity && hastoonear) {
                    this.warningTip.setString("* 发现距离过近、未检测到位置的玩家，是否解散？");
                } else if (hasnocity) {
                    this.warningTip.setString("* 发现未检测到位置的玩家，是否解散？");
                } else if (hastoonear) {
                    this.warningTip.setString("* 发现距离过近的玩家，是否解散？");
                }
            }

            MJModel.mj_table.room_Action.updateGPSTip(hasnocity, hastoonear);
            if (MJModel.mj_table.pre_scene) {
                MJModel.mj_table.pre_scene.updateGPSTip(hasnocity, hastoonear);
            }
        };
    },

    playBgSound: function () {
        if (MJModel.yinyue == "jingkuai") {
            Sound.getInstance().PlayBgSound(getResPath("RoomMJ/sound/csmj1.mp3"));
        } else if (MJModel.yinyue == "suhuan") {
            Sound.getInstance().PlayBgSound(getResPath("RoomMJ/sound/csmj2.mp3"));
        } else {
            Sound.getInstance().PlayBgSound(getResPath("gaoyou/sound/music_hall.mp3"));
        }
    },
    _sortCard: function (a, b) {
        try {
            var av = a;
            var bv = b;
            if (typeof a === "object") av = a.getValue();
            if (typeof b === "object") bv = b.getValue();
            if (this._isLaizi(av) && !this._isLaizi(bv))return 1;//赖子放在最前边
            if (!this._isLaizi(av) && this._isLaizi(bv))return -1;//赖子放在最前边
            return bv - av;
        } catch (e) {
            return 0;
        }
    },
    test: function (dt) {
        MJModel.testCount++;
        var tempCount = MJModel.testCount;
        if (tempCount == 5 && true) {
            var packet = {
                "gameend": {
                    "UserCard": [{
                        "ChangeableCardsLen": 13,
                        "ChangeableCards": [1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 5, 22, 23],
                        "FixedCardsLen": 0,
                        "stFixedCards": [],
                        "stFenZhangCard": null
                    }, {
                        "ChangeableCardsLen": 13,
                        "ChangeableCards": [1, 2, 3, 8, 8, 23, 24, 33, 35, 37, 38, 39, 40],
                        "FixedCardsLen": 0,
                        "stFixedCards": [],
                        "stFenZhangCard": null
                    }, {
                        "ChangeableCardsLen": 14,
                        "ChangeableCards": [21, 23, 23, 24, 25, 35, 35, 35, 36, 36, 36, 37, 37, 40],
                        "FixedCardsLen": 0,
                        "stFixedCards": [],
                        "stFenZhangCard": null
                    }, {
                        "ChangeableCardsLen": 13,
                        "ChangeableCards": [17, 19, 22, 22, 22, 23, 24, 37, 37, 38, 38, 39, 40],
                        "FixedCardsLen": 0,
                        "stFixedCards": [],
                        "stFenZhangCard": null
                    }],
                    "Score": [-24, -24, 72, -24],
                    "EndState": 0,
                    "EndGangInfo": [{"Gang": [], "TotalGangScore": 0}, {"Gang": [], "TotalGangScore": 0}, {
                        "Gang": [],
                        "TotalGangScore": 0
                    }, {"Gang": [], "TotalGangScore": 0}],
                    "faninfo": [{
                        "chairid": 0,
                        "SpecialType": 4,
                        "FanNum": 0,
                        "addfan": [],
                        "hucard": 0,
                        "DianPao": []
                    }, {
                        "chairid": 1,
                        "SpecialType": 4,
                        "FanNum": 0,
                        "addfan": [],
                        "hucard": 0,
                        "DianPao": []
                    }, {
                        "chairid": 2,
                        "SpecialType": 1,
                        "FanNum": 0,
                        "addfan": [{"AddType": 10, "AddNum": 9, "AddType2": null}, {
                            "AddType": 9,
                            "AddNum": 3,
                            "AddType2": null
                        }, {"AddType": 17, "AddNum": 0, "AddType2": null}, {
                            "AddType": 13,
                            "AddNum": 12,
                            "AddType2": null
                        }],
                        "hucard": 35,
                        "DianPao": []
                    }, {"chairid": 3, "SpecialType": 4, "FanNum": 0, "addfan": [], "hucard": 0, "DianPao": []}],
                    "money": [999976, 999976, 1000072, 999976]
                },
                "endinfo": [{
                    "baotingscore": null,
                    "xiscore": 0,
                    "xiaoxinum": null,
                    "daxinum": null
                }, {"baotingscore": null, "xiscore": 0, "xiaoxinum": null, "daxinum": null}, {
                    "baotingscore": null,
                    "xiscore": 0,
                    "xiaoxinum": null,
                    "daxinum": null
                }, {"baotingscore": null, "xiscore": 0, "xiaoxinum": null, "daxinum": null}],
                "hualist": [{"card": []}, {"card": []}, {"card": []}, {"card": [81]}]
            };
            this.handler_server_game_end_bc(packet);
        }
    },

    handler_cmd: function (cmd, jpacket, canDelay, svrid) {
        if (cmd == CMD.SERVER_GAME_SCENE) {
            this.handlerTableInfo(this.tableData);
            var ackGameFree = parsePacket("proto.game.gaoyoumj.tagCurGameScence", jpacket);
            this.handler_server_scene_info_uc(ackGameFree, canDelay);
            return;
        }
        if (cmd == CMD.SERVER_GAME_END) {
            var ackGameEnd = parsePacket("proto.game.gaoyoumj.AckCurGameEnd", jpacket);
            this.handler_server_game_end_bc(ackGameEnd, canDelay);
            return;
        }
        if (cmd == CMD.SERVER_GAME_RECORD) {
            this._handler_game_record(jpacket, canDelay);
            return;
        }
        if (cmd == selfCMD.SERVER_Laizi_BC) {
            this._handler_server_laizi_bc(jpacket, canDelay);
            return;
        }

        if (cmd == selfCMD.SERVER_CHANGE_CARD) {
            this._handler_server_buhua_bc(jpacket, canDelay);
            return;
        }

        if (cmd == selfCMD.SERVER_CHANGE_CARD_NEW) {
            this._handler_server_buhua_bc2(jpacket, canDelay);
            return;
        }

        if (cmd == selfCMD.SERVER_ROBOT_SER) {
            this._handler_server_tuoguan(jpacket, canDelay);
            return;
        }
        this._super(cmd, jpacket, canDelay, svrid);
    },

    _handler_server_buhua_bc2: function (data, canDelay) {
        var packet = parsePacket("proto.game.gaoyoumj.AckBuHuaNew", data);
        var buhua = packet.buhua;
        var leftcount = packet.leftcount;
        this.room_Info.showCardNums(leftcount, true);
        this._show_buhua_action(buhua.chairid, buhua.hua, buhua.getcard, canDelay);
    },

    _handler_server_buhua_bc: function (data, canDelay) {
        var packet = parsePacket("proto.game.gaoyoumj.AckBuHua", data);
        var buhua = packet.buhua;
        var leftcount = packet.leftcount;
        this.room_Info.showCardNums(leftcount, true);
        var alldata = [];
        var pnum = 4;
        if (MJModel.mj_roomType == 1) pnum = 3;
        if (MJModel.mj_roomType == 2) pnum = 2;

        for (var i = MJModel.banker_seatid; i < (MJModel.banker_seatid + buhua.length); i++) {
            var s = i;
            if (s >= pnum) s -= pnum;
            for (var j = 0; j < buhua.length; j++) {
                if (buhua[j].chairid == s) {
                    if (buhua[j].hua.length == 0)break;
                    var data = {};
                    data.chairid = buhua[j].chairid;
                    data.hua = buhua[j].hua;
                    data.getcard = buhua[j].getcard;
                    alldata.push(data);
                    break;
                }
            }
        }

        var self = this;
        var count = -1;

        var callback1 = cc.callFunc(function () {
            count++;
            var data = alldata[count];
            if (data) {
                self._show_buhua_action(data.chairid, data.hua, data.getcard, canDelay);
            }
        });

        if (alldata.length != 0) {
            if (canDelay) {
                MJModel.isEnterWait = true;
                var self = this;
                var callback = cc.callFunc(function () {
                    MJModel.isEnterWait = false;
                });
                this.runAction(cc.sequence(cc.sequence(cc.delayTime(0.3), callback1).repeat(alldata.length), cc.delayTime(1), callback));
            }
            else {
                for (var i = 0; i < alldata.length; i++) {
                    var data = alldata[i];
                    this._show_buhua_action(data.chairid, data.hua, data.getcard, canDelay);
                }
            }
        }
    },

    _show_buhua_action: function (seatId, huaArr, getcardArr, canDelay) {
        var pos = MJModel.getPosBySeatid(seatId);
        for (var j = 0; j < huaArr.length; j++) {
            this.room_Card.removeHandCard(pos, huaArr[j]);
        }
        for (var j = 0; j < getcardArr.length; j++) {
            if (MJModel.isMyPlayer(seatId) || MJModel.isOnVideo) {
                this.room_Card.addHandCard(pos, getcardArr[j]);
            } else {
                this.room_Card.addHandCard(pos, 0);
            }

            //this.room_Card.removePublicCardByNums(1,false);
        }
        this.room_Card.reflashHandCard(pos);

        for (var j = 0; j < huaArr.length; j++) {
            this.room_Card.addOutCard(pos, huaArr[j]);
            //this.room_Card.removeHandCard(pos, huaArr[j]);
        }
        if (canDelay && (huaArr.length > 0)) {
            this._ShowEffect("buhua", pos);
            var player = MJModel.players[seatId];
            Sound.getInstance().playEffect(__String.createWithFormat(getResPath("gaoyou/sound/operator/%1_buhua.mp3"), "w"));
        }

        if (MJModel.isMyPlayer(seatId) && this.room_Card.isDuoPai(0)) {
            MJModel.mj_mo_cards[0] = getcardArr[getcardArr.length - 1];
            var is_ok = this.room_Card.removeHandCard(0, MJModel.mj_mo_cards[0]);
            if (is_ok) this.room_Card.initMoCard(0, MJModel.mj_mo_cards[0], true);
        }
    },

    _handler_server_tuoguan: function (data, canDelay) {
        var packet = parsePacket("proto.game.gaoyoumj.AckRobot", data);
        var chairid = packet.chairid;
        var robot = packet.robot;

        var pos = MJModel.getPosBySeatid(chairid);
        if (this._tuoguanFlag[pos]) {
            this._tuoguanFlag[pos].setVisible(robot);
        }

        if (MJModel.isMyPlayer(chairid)) {
            if (this._tuoguanBtn) {
                this._tuoguanBtn.setVisible(robot);
            }
            //取消托管的时候 检查是不是报听状态 报听状态检查自动出牌
            if (robot == 0) {
                this.checkAutoOutCard();
            }
        }
    },

    _isHuaPai: function (card) {
        try {
            var allhua = [0x41, 0x42, 0x43, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58];
            if (allhua.indexOf(card) != -1) {
                return true;
            } else {
                return false;
            }
        } catch (e) {
            return false;
        }
    },

    _isLaizi: function (card) {
        try {
            var allhua = [this._curLaizi];
            if (this._curLaizi == 0x51 || this._curLaizi == 0x52 || this._curLaizi == 0x53 || this._curLaizi == 0x54)allhua = [0x51, 0x52, 0x53, 0x54];
            if (this._curLaizi == 0x55 || this._curLaizi == 0x56 || this._curLaizi == 0x57 || this._curLaizi == 0x58)allhua = [0x55, 0x56, 0x57, 0x58];
            if (allhua.indexOf(card) != -1) {
                return true;
            } else {
                return false;
            }
        } catch (e) {
            return false;
        }
    },

    isSupportVideoAction: function () {
        return false;
    },
    _buhua: [0, 0, 0, 0],
    handler_server_out_card_bc: function (data, canDelay) {
        this._super(data, canDelay);
        var userOutCard = parsePacket("proto.game.AckUserOutCard", data);
        var seatId = userOutCard.ChairID;
        var card = userOutCard.Card;
        var da_type = userOutCard.da_type;
        var pos = MJModel.getPosBySeatid(seatId);
        if (da_type == 1) {
            //报听
            if (canDelay) {
                this._ShowEffect("baoting", pos);
                Sound.getInstance().playEffect(__String.createWithFormat(getResPath("gaoyou/sound/operator/%1_pa.mp3"), "w"));
            }
            if (MJModel.isMyPlayer(seatId)) {
                MJModel.mj_lockcard_type = 2;
            }
            this.players[pos].setLiangPaiVisible(true);

            MJModel.final_listen_info = [];
            //检测出的牌是否在听牌里边 不在的话就清楚听牌信息
            for (var i = 0; i < MJModel.listen_info2.length; i++) {
                var lsi = MJModel.listen_info2[i];
                if (lsi.OutCard == card) {
                    MJModel.final_listen_info = lsi.HuInfo;
                    break;
                }
            }

            MJModel.listen_info = [];
            MJModel.listen_info2 = [];

            //可以听牌  可以选择自动胡牌
            if (MJModel.final_listen_info.length > 0) {
                if (this.room_Action) this.room_Action.checkAutoOutCardVis();
                this.room_Card.setAutoOutCard(MJModel.isAutoOutCard);
            }
            else {
                if (this.room_Action) this.room_Action.setAutoOutCardVis(false);
                this.room_Card.setAutoOutCard(false);
                MJModel.isAutoOutCard = false;
            }

            this.myselfCloseOutCard();
        }
        if (this._isHuaPai(card)) {
            if (canDelay && this._buhua[pos] == 0) {
                var player = MJModel.players[seatId];
                this._ShowEffect("buhua", pos);
                Sound.getInstance().playEffect(__String.createWithFormat(getResPath("gaoyou/sound/operator/%1_buhua.mp3"), "w"));
            }
            this._buhua[pos]++;
        } else {
            this._buhua[pos] = 0;
        }
    },

    _ShowEffect: function (name, pos) {
        return;
        try {
            var begin = MJConfig.getOperatorTipPos(pos);
            var armature = null;
            var effect_name = "";
            if (name == "buhua") {
                effect_name = "effects_mjxxbuhuax";
                ccs.armatureDataManager.addArmatureFileInfo(getResPath("gaoyou/effect/buhua/effects_mjxxbuhuax.ExportJson"));
            }
            if (name == "baoting") {
                effect_name = "effects_mjxbaoting";
                ccs.armatureDataManager.addArmatureFileInfo(getResPath("gaoyou/effect/ting/effects_mjxbaoting.ExportJson"));
            }
            armature = new ccs.Armature(effect_name);
            if (armature != null) {
                var animation = armature.getAnimation();
                if (animation) {
                    if (typeof animation.playWithIndex === "function") {
                        animation.playWithIndex(0);

                        armature.setPosition(begin);
                        this.room_Tip.addChild(armature, 10000);
                    }
                }
                armature.runAction(cc.sequence(cc.delayTime(1), cc.removeSelf()));
            }
        } catch (e) {
            Log(this, e);
        }
    },

    myselfOpenOutCard: function (IsMoCard, showTip) {
        this._super(IsMoCard, showTip);
        this.checkAutoOutCard();
    },
    checkAutoOutCard: function () {
        if (MJModel.isMyPlayer(MJModel.cur_seat) && this.room_Card.isDuoPai(0) && MJModel.mj_lockcard_type == 2 && this._tuoguanBtn.isVisible() == false) {
            this.autoOutCard();
        }
    },
    autoOutCard: function () {
        this.schedule(this.autoOutCardTimeOut, 0.5);
    },
    autoOutCardTimeOut: function (dt) {
        if (MJModel.TouPiaoING == true) return;//投票期间 该功能不起作用
        this.unschedule(this.autoOutCardTimeOut);
        var operate = MJModel.curOperate;
        if (( operate & ActionType.TYPE_LISTEN) == ActionType.TYPE_LISTEN) {
            operate = operate - ActionType.TYPE_LISTEN;
        }

        if (operate > 0) {
            return;
        }
        sendOutCard(MJModel.curOperateCard);
    },

    handler_server_update_info_uc: function (data, canDelay) {
    },

    _handler_game_record: function (data, canDelay) {
        //-----新总结算界面
        cc.log("------big End");
        if (this.isRecordShow) {
            return;
        }
        this.isRecordShow = true;
        var self = this;
        this.resetGame(false);
        var pkgId = this._pkg_id;
        var gameType = "高邮麻将";

        var gameRecord = parsePacket("proto.game.GameEndRecord", data);
        var bigResult = new CommonTotalResult();
        this.addChild(bigResult, 100000);

        var time = Utils.getTime(gameRecord.DataTime * 1000);
        var startTime = Utils.getTime(MJModel.roomData["gameRoom"]["createTime"]);

        var roomId = "房间号:" + MJModel.roomData["gameRoom"]["code"];
        gameType += " · " + MJModel.base_money + "分底";

        bigResult.initUI(gameType, roomId, time, startTime, MJModel.RoomCountSum, MJModel.currentCount);
        bigResult.back_btn.addClickEventListener(function (node) {
            self.exitRoom(true);
        });
        //var _winSeatid = [0, 0, 0, 0];
        var _PaoSeatid = [0, 0, 0, 0];
        for (var i = 0; i < gameRecord.MostDianPaoUser.length; i++) {
            var seatId = gameRecord.MostDianPaoUser[i];
            if (seatId != 255) {
                _PaoSeatid[seatId] = 1;
            }
        }
        var addX = 0;
        var PlayerNumber = 0;
        var has_result = false;
        var houseOwner = false;

        var max_score = 0;
        for (var i = 0; i < gameRecord.UserRecoreInfo.length; i++) {
            var recoreInfo = gameRecord.UserRecoreInfo[i];
            if (recoreInfo.totalscore > max_score) {
                max_score = recoreInfo.totalscore;
            }
        }

        for (var i = 0; i < gameRecord.UserRecoreInfo.length; i++) {
            var recoreInfo = gameRecord.UserRecoreInfo[i];
            //var playerRecord = totalRecord.player_records[i];
            var player = MJModel.players[i];
            var arrStr = [];
            //次数
            var arrcount = [];

            arrStr = ["坐庄次数", "胡牌次数", "点炮次数", "超时次数"];
            arrcount = [recoreInfo.banker_num, recoreInfo.hu_num, recoreInfo.Ex1, recoreInfo.outtime_num];

            if (player && player.uid != -1 && player.uid != 0) {
                if (MJModel.roomData["gameRoom"]["userId"] == player.uid) {
                    houseOwner = true;
                } else {
                    houseOwner = false;
                }
                var isWin = false;
                if (max_score > 0 && recoreInfo.totalscore == max_score) {
                    isWin = true;
                }
                var Item = bigResult.addItem(player.avatar, player.name, player.uid, isWin, _PaoSeatid[i], arrStr, arrcount, recoreInfo.totalscore, houseOwner, recoreInfo.dissState);
                Item.setAnchorPoint(cc.p(0.5, 0.5));
                bigResult.player_records[i] = Item;
                PlayerNumber++;
            }
        }
        bigResult.refresh(PlayerNumber);
        this.release();
    },

    handler_server_game_end_bc: function (hubeiGameend, canDelay) {
        Log(this, "handler_server_game_end_bc");
        try {
            var ackGameEnd = hubeiGameend.gameend;
            var self = this;
            this.room_Card.setAutoOutCard(false);
            if (this.room_Action) this.room_Action.setTingPaiVis(false);
            if (this.room_Action) this.room_Action.setAutoOutCardVis(false);
            if (this.room_Action) this.room_Action.setOperator(-1);
            this.room_Info.stopTime();
            this.room_Tip.hideOutCardTip();

            var show_all_handcard = cc.callFunc(function () {
                self.gameend_showAllHandCard(ackGameEnd);
            });

            var state = ackGameEnd.EndState;
            var show_liuju = cc.callFunc(function () {
                if (ackGameEnd.EndState == 1) {
                    //流局
                    self.room_Tip.ShowGameState(3);
                }
            });

            var show_end_score = cc.callFunc(function () {
                self.gameend_showAllScoreEffect(ackGameEnd);
            });

            var update_all_money = cc.callFunc(function () {
                self.gameend_updatePlayersInfo(ackGameEnd);
            });

            var game_end_reset = cc.callFunc(function () {
                self.room_Action.setReady2Visible(false);
                try {
                    var result = new MJResult_XinYu();
                    result.updateContentView(hubeiGameend);
                    result.setName("reset_remove");
                    self.addChild(result, 100000);
                } catch (e) {
                    cc.log("game end:", e);
                    self.room_Action.setReady2Visible(true);
                }
            });

            var show_all_public_card = cc.callFunc(function () {
                self.gameend_showAllPublicCard(ackGameEnd);
            });

            if (MJModel.isOnVideo && canDelay == false) {
                this.runAction(cc.sequence(show_all_public_card, show_all_handcard, cc.delayTime(2), update_all_money));
                return;
            }

            this.runAction(cc.sequence(show_all_public_card, show_all_handcard, cc.delayTime(1), show_liuju, cc.delayTime(ackGameEnd.EndState == 1 ? 1 : 0), show_end_score, cc.delayTime(0), update_all_money, cc.delayTime(1), game_end_reset));
        } catch (e) {
            ERROR(this, "handler_server_game_end_bc" + e);
        }
    },

    timeEnd: function (dt) {

        if (MJModel.isEnd)return;

        if (MJModel.isState(MJ_STATUS.MJ_GAME_FREE)) {
            sendGameEndRecordReq();
        }
    },

    handler_server_peng_kang_bc: function (data, canDelay) {
        var ackBcOpResult = parsePacket("proto.game.AckBcOpResult", data);

        var seatid = ackBcOpResult.ChairID;
        var out_seatid = ackBcOpResult.OutCardChairID;
        var OpType = ackBcOpResult.OpType;
        var OpType2 = ackBcOpResult.OpType2;
        var card = ackBcOpResult.Card;

        var pos = MJModel.getPosBySeatid(seatid);
        var out_pos = MJModel.getPosBySeatid(out_seatid);

        //if ((OpType & ActionType.TYPE_PASS) != ActionType.TYPE_PASS && (OpType & ActionType.TYPE_ZHIGANG) == ActionType.TYPE_ZHIGANG && card == this._curLaizipi) {
        //    this.room_Tip.showTextTip("");
        //    var scores = ackBcOpResult.Score;
        //    this.handler_gang_scores(scores, OpType, OpType2, canDelay);
        //    this.room_Card.addPengCard(pos, PengType.Peng_Kang, card, out_pos, OpType);
        //    this.room_Card.removeHandCard(pos, card, 2);
        //    MJModel.cur_seat = seatid;
        //    this.room_Card.removeOutCard(out_pos, card, canDelay);
        //    this.room_Card.setCurCardTip(false);
        //    this.room_Info.showDirectionTip(pos);
        //    if (MJModel.isMyPlayer(seatid)) {
        //        if (this.room_Action)this.room_Action.setOperator(-1);
        //        this.myselfOpenOutCard();
        //    }
        //    var player = MJModel.players[seatid];
        //    if (player && canDelay) {
        //        this.handler_op_sound(pos, player.sex, OpType, OpType2, "");
        //        this.handler_op_effect(pos, out_pos, player.sex, OpType, OpType2);
        //    }
        //    return;
        //}

        if ((OpType & ActionType.TYPE_PASS) != ActionType.TYPE_PASS && (OpType & ActionType.TYPE_ANGANG) == ActionType.TYPE_ANGANG && card == this._curLaizipi) {
            var scores = ackBcOpResult.Score;
            this.handler_gang_scores(scores, OpType, OpType2, canDelay);
            this.room_Card.addPengCard(pos, PengType.Peng_AnKang, card, out_pos, OpType);
            this.room_Card.removeHandCard(pos, card, 3);
            MJModel.cur_seat = seatid;
            this.room_Info.showDirectionTip(pos);
            if (MJModel.isMyPlayer(seatid)) {
                if (this.room_Action)this.room_Action.setOperator(-1);
                this.myselfOpenOutCard();
            }
            var player = MJModel.players[seatid];
            if (player && canDelay) {
                this.handler_op_sound(pos, player.sex, OpType, OpType2, "gang");
                this.handler_op_effect(pos, out_pos, player.sex, OpType, OpType2);
            }
            return;
        }
        this._super(data, canDelay);
    },

    _handler_server_laizi_bc: function (data, canDelay) {
        var packet = parsePacket("proto.game.gaoyoumj.AckLaiziCard", data);
        var self = this;
        var curLaizi = packet.laizicard;
        var chaotian = packet.laizipicard;
        var cardLeft = packet.cardnum;
        this.room_Info.showCardNums(cardLeft);
        this._setLaizi(curLaizi, chaotian, -1, canDelay ? true : false);
        if (canDelay == false) {
            this._showHandcardFlag(false);
            this.room_Card.reflashHandCard(0, true);
            this.room_Card.reflashHandCard(1, true);
            this.room_Card.reflashHandCard(2, true);
            this.room_Card.reflashHandCard(3, true);
            return;
        }
        MJModel.isEnterWait = true;

        var move_end = cc.callFunc(function () {
            self._showHandcardFlag(false);

            var mo_card = null;
            if (self.room_Card.isDuoPai(0)) {
                mo_card = self.room_Card.hand_card[0][self.room_Card.hand_card[0].length - 1];
                self.room_Card.hand_card[0].splice(self.room_Card.hand_card[0].length - 1, 1);
            }

            var allPreCars = [];
            var allLaiZi = [];
            var dd = 0;

            for (var i = self.room_Card.hand_card[0].length - 1; i >= 0; i--) {
                var card = self.room_Card.hand_card[0][i];
                if (card.getValue() == curLaizi) {
                    allLaiZi.push(card);
                } else {
                    if (allLaiZi.length > 0) {
                        break;
                    }
                    allPreCars.push(card);
                }
            }

            if (allLaiZi.length > 0 && allPreCars.length > 0) {
                var allDelay = 0;
                for (var i = 0; i < allLaiZi.length; i++) {
                    var card = allLaiZi[i];
                    var begin_pos = card.getPosition();
                    var end_pos = MJConfig.getHandCardPos(0, self.room_Card.hand_card[0].length - 1 - i, self.room_Card.hand_card[0].length, self.room_Card.isDuoPai(0));
                    var allL = Math.abs(end_pos.x - begin_pos.x);

                    //if (MJModel.outCardEffect_style == 0 || true) {
                    var time = allL / 1000;
                    if (time < 0.17) time = 0.17;
                    if (time > 0.3) time = 0.3;
                    card.runAction(cc.sequence(cc.spawn(cc.rotateTo(0.1, 15), cc.moveTo(0.17, cc.p(begin_pos.x + 0, begin_pos.y + 100))), cc.moveTo(time, cc.p(end_pos.x + 0, end_pos.y + 100)).easing(cc.easeSineOut()), cc.spawn(cc.rotateTo(0.1, 0), cc.moveTo(0.17, end_pos))));
                    allDelay += 1;
                }
                for (var i = 0; i < allPreCars.length; i++) {
                    var card = allPreCars[i];
                    //card.runAction(cc.sequence(cc.moveBy(0.3, cc.p(83, 0)), cc.delayTime(1 - 0.3)).repeat(allLaiZi.length));
                    card.runAction(cc.moveBy(0.3, cc.p(83 * allLaiZi.length, 0)));
                }

                var callback = cc.callFunc(function () {
                    MJModel.isEnterWait = false;
                    self.room_Card.reflashHandCard(0, true);
                    if (mo_card) {
                        mo_card.setMyPosition(MJConfig.getMoCardPos(0));
                        self.room_Card.hand_card[0].push(mo_card);
                    }
                });
                self.runAction(cc.sequence(cc.delayTime(0.5), callback));
            } else {
                MJModel.isEnterWait = false;
                self.room_Card.reflashHandCard(0, true);
                if (mo_card) {
                    mo_card.setMyPosition(MJConfig.getMoCardPos(0));
                    self.room_Card.hand_card[0].push(mo_card);
                }
            }
        });
        this.runAction(cc.sequence(cc.delayTime(1), move_end));
    },

    _setGameType: function () {
        var pkg_id = 1;
        var play_id = [];
        //甩字胡不可炮胡
        play_id.push(MJModel.base_money + "分底");

        if (MJModel.RoomConfigID.indexOf(1499001) != -1) {
            play_id.push("包三嘴");
        }

        if (MJModel.RoomConfigID.indexOf(1499002) != -1) {
            play_id.push("起手报听");
        }

        if (MJModel.RoomConfigID.indexOf(1500001) != -1) {
            play_id.push("超时3分钟托管");
        }
        MJModel.play_id_str = play_id;

        var gameDes = "";
        for (var i = 0; i < play_id.length; i++) {
            gameDes += play_id[i];
            if (i != play_id.length - 1) {
                gameDes += " ";
            }
        }
        cc.eventManager.dispatchCustomEvent("notify_mjpublic_roomConfig", gameDes);
        this._setFastChat();
    },
    fastChat3: [
        "各位老板老板娘好",
        "快点快点",
        "不要虚在，把我想哈在",
        "吵什么呢，好好打",
        "来个自摸",
        "什么啊，你们两个打帘子的吗",
        "怪，手骚呢吗",
        "没有意思，今天手气不好",
        "我先走了，有点事，下次再玩",
        "一个不准走，打到天亮",
        "回头留个联系方式",
        "又断网了，网络太差了",
    ],
    _setFastChat: function () {
        var chatList = [];
        chatList = this.fastChat3;
        MJModel.mj_fastChat = this.fastChat3;
        var self = this;
        Utils.getFastChatSound = function (chat, sex) {
            for (var i = 0; i < chatList.length; i++) {
                if (chatList[i] == chat) {
                    return getResPath(__String.createWithFormat("gaoyou/sound/fastchat/%1_%2.mp3", "w", i + 1));
                }
            }
            return "";
        };
    },

    _showLaizi_effect: function (name) {
        ccs.armatureDataManager.addArmatureFileInfo(getResPath("gaoyou/effect/laizi/effects_mjhunancx.ExportJson"));
        var size = cc.director.getWinSize();
        if (true) {
            var armature = new ccs.Armature("effects_mjhunancx");
            var animation = armature.getAnimation();
            if (animation) {
                if (typeof animation.playWithIndex === "function") {
                    animation.playWithIndex(0, -1, 0);
                    armature.setPosition(cc.p(size.width / 2, size.height / 2));
                    this.addChild(armature, 100);
                    armature.runAction(cc.sequence(cc.delayTime(1.0), cc.removeSelf()));
                }
            }
        }
        Sound.getInstance().playEffect(__String.createWithFormat(getResPath("gaoyou/sound/laizi.mp3")));
        return armature;
    },
    _setLaizi: function (laizi, laizipi, laizipi2, gamestart) {
        this._curLaizi = laizi;
        this._curLaizipi = laizipi;
        this._curLaizipi2 = laizipi2;

        var size = cc.director.getWinSize();
        if (laizi == null || laizi == undefined || laizi == -1 || laizi == 255) {
            if (this._curLaizi_bg) this._curLaizi_bg.setVisible(false);
            return;
        }
        if (gamestart == undefined) gamestart = false;

        if (this._curLaizi_bg == null) {
            this._curLaizi_bg = new cc.Sprite(getResPath("gaoyou/flag/laizi_bg3.png"));
            this._curLaizi_bg.setPosition(cc.p(size.width - 220, size.height - 70));
            this.addChild(this._curLaizi_bg, 200);
        }
        this._curLaizi_bg.removeAllChildren();
        this._curLaizi_bg.setVisible(true);

        if (this._curLaizipi > 0) {
            var card = new MJCard();
            card.setValue(this._curLaizi, 0, CardType.Card_Out, 0);
            card.setPosition(cc.p(this._curLaizi_bg.getContentSize().width / 2, this._curLaizi_bg.getContentSize().height / 2));
            card.setScale(1);
            //card.setStoreColor(cc.color(255, 249, 137));
            this._curLaizi_bg.addChild(card);
            this.room_Card.other_card.push(card);

            if (gamestart) {
                var dl = 0;
                var ppos = card.getPosition();
                card.setScale(0);
                card.setVisible(false);
                var self = this;
                var callFunc = cc.CallFunc(function () {
                    self._showLaizi_effect("赖子皮");
                });
                card.setPosition(cc.p(size.width / 2 - this._curLaizi_bg.getPositionX() + this._curLaizi_bg.getContentSize().width / 2, size.height / 2 - this._curLaizi_bg.getPositionY() + this._curLaizi_bg.getContentSize().height / 2));
                card.runAction(cc.sequence(cc.delayTime(0 + dl), cc.show(), callFunc, cc.scaleTo(0.1, 2), cc.delayTime(1.0), cc.spawn(cc.moveTo(0.17, ppos), cc.scaleTo(0.17, 1))));
            }
        }
    },

    _showHandcardFlag: function (isEndShow) {
        if (MJModel.isOnVideo) {
            for (var j = 0; j < 4; j++) {
                var allcards = this.room_Card.hand_card[j];
                if (allcards) {
                    for (var i = 0; i < allcards.length; i++) {
                        var card = allcards[i];
                        this._checkAddCardFlag(card);
                    }
                }
            }
            return;
        }
        var allcards = this.room_Card.hand_card[0];
        if (allcards) {
            for (var i = 0; i < allcards.length; i++) {
                var card = allcards[i];
                this._checkAddCardFlag(card);
            }
        }
    },
    _checkAddCardFlag: function (card) {
        try {
            if (card.type == CardType.Card_Outing)return;
            if (card.type == CardType.Card_Peng)return;
            if (card.getValue() == 0)return;
            var flag_str = "";
            if (this._isLaizi(card.getValue())) {
                flag_str = "gaoyou/flag/lai_flag2.png";
                if (card.pos == 1)flag_str = "gaoyou/flag/laizi_out_flag_1.png";
                //if (card.pos == 2)flag_str = "gaoyou/flag/laizi_out_flag_2.png";
                if (card.pos == 3)flag_str = "gaoyou/flag/laizi_out_flag_3.png";
            }
            if (flag_str != "") {
                if (this._isLaizi(card.getValue()))card.setStoreColor(cc.color(255, 249, 137));
                var p = card.getChildByName("sprite");
                p.removeChildByName("laizi_flag");
                var flag = null;

                flag = new cc.Sprite(getResPath(flag_str));

                var m_size = p.getContentSize();
                if (flag) {
                    flag.setScale(0.5);
                    flag.setPosition(cc.p(0, m_size.height));
                    flag.setAnchorPoint(cc.p(0, 1));
                    flag.setName("laizi_flag");
                    p.addChild(flag);
                    this._flagDirection(card.pos, flag, m_size);
                    if (card.pos == 0 && card.type != CardType.Card_Out)flag.setScale(1);
                }
                return;
            }
        } catch (e) {
            Log(this, e);
        }
    },
    //每个方向角标对应
    _flagDirection: function (pos, flag, m_size) {
        if (MJModel.mj_bg_use == 1) {
            if (pos == 1) {
                flag.setAnchorPoint(cc.p(0, 0));
                flag.setPosition(cc.p(0, 13));
                flag.setScale(1);
            } else if (pos == 2) {
                //flag.setAnchorPoint(cc.p(1, 0));
                //flag.setPosition(cc.p(m_size.width, 5));
                flag.setScale(0.5);
            } else if (pos == 3) {
                flag.setAnchorPoint(cc.p(1, 1));
                flag.setPosition(cc.p(m_size.width, m_size.height));
                flag.setScale(1);
            }
        } else {
            if (pos == 1) {
                flag.setAnchorPoint(cc.p(0, 0));
                flag.setPosition(cc.p(10, 17));
                flag.setScale(1);
            } else if (pos == 2) {
                //flag.setAnchorPoint(cc.p(1, 0));
                //flag.setPosition(cc.p(m_size.width, 5));
                flag.setScale(0.4);
            } else if (pos == 3) {
                flag.setAnchorPoint(cc.p(1, 1));
                flag.setPosition(cc.p(m_size.width - 10, m_size.height));
                flag.setScale(1);
            }
        }
    },
    resetGame: function (allClean) {
        this._super(allClean);
        this._setLaizi(-1, -1, -1);
        this._buhua = [0, 0, 0, 0];
    },
    handler_server_scene_info_uc: function (hubei_scene, canDelay) {
        var ackGameFree = hubei_scene.GameSence;
        var sceneStatus = ackGameFree.SceneStatus;
        if (hubei_scene.laizicard && hubei_scene.laizicard > 0) {
            this._setLaizi(hubei_scene.laizicard, hubei_scene.laizipicard, -1, false);
        }

        if (hubei_scene.State && hubei_scene.State.length > 0) {
            for (var i = 0; i < hubei_scene.State.length; i++) {
                var pos = MJModel.getPosBySeatid(i);
                var state = hubei_scene.State[i];
                this.players[pos].setLiangPaiVisible(state == 1);
                if (MJModel.isMyPlayer(i) && state == 1)MJModel.mj_lockcard_type = 2;
            }
        }

        this._super(ackGameFree, canDelay);

        this._setGameType();

        var robots = hubei_scene.robots;
        if (robots) {
            for (var i = 0; i < robots.length; i++) {
                var pos = MJModel.getPosBySeatid(i);
                if (this._tuoguanFlag[pos]) {
                    this._tuoguanFlag[pos].setVisible(robots[i]);
                }

                if (pos == 0) {
                    if (this._tuoguanBtn) {
                        this._tuoguanBtn.setVisible(robots[i]);
                    }
                }
            }
        }

        MJModel.listen_info2 = hubei_scene.ListenInfo1;
    },
    handler_out_card_sound: function (sex, card) {
        if (this._isHuaPai(card))return;
        if (MJModel.mj_suport_fangyan == 1 && MJModel.fangyan != "putonghua") {
            Sound.getInstance().playEffect(getResPath("RoomMJ/sound/operator/luopai.mp3"));
            Sound.getInstance().playEffect(__String.createWithFormat(getResPath("gaoyou/sound/chupai/%1_%2.mp3"), "w", Utils.toHex2(card)));
        } else {
            this._super(sex, card);
        }
    },

    handler_op_sound: function (pos, sex, OpType, OpType2, effect) {
        if (MJModel.mj_suport_fangyan == 1 && MJModel.fangyan != "putonghua") {
            if ((OpType & ActionType.TYPE_ANGANG) == ActionType.TYPE_ANGANG) {
                effect = "gang";
            }
            else if ((OpType & ActionType.TYPE_ZHIGANG) == ActionType.TYPE_ZHIGANG) {
                effect = "gang";
            }
            else if ((OpType & ActionType.TYPE_WANGANG) == ActionType.TYPE_WANGANG) {
                effect = "gang";
            }
            else if ((OpType & ActionType.TYPE_HU) == ActionType.TYPE_HU && effect == "") {
                var zimo = this.room_Card.isDuoPai(pos);
                effect = "hu";
                if (zimo) {
                    effect = "zimo";
                }
            } else if ((OpType & ActionType.TYPE_PENG) == ActionType.TYPE_PENG) {
                effect = "peng";
            }
            if (effect == "qiangganghu") {
                effect = "hu";
            }
            Sound.getInstance().playEffect(__String.createWithFormat(getResPath("gaoyou/sound/operator/%1_%2.mp3"), "w", effect));
        } else {
            this._super(pos, sex, OpType, OpType2, effect);
        }
    },

    handler_op_effect: function (pos, out_pos, sex, OpType, OpType2, effect) {
        this.room_Tip.showEffect(pos, OpType, this.room_Card.isDuoPai(pos));
        // this.room_Tip.showSimpleEffect(pos, out_pos, OpType, effect);
    },
});

var MJResult_XinYu = MJCommonResult.extend({
    updateContentView: function (ackGameEndJS) {
        this.ackGameEnd = ackGameEndJS.gameend;
        this.ackGameEndJS = ackGameEndJS;
        //输赢标志
        var seatId = MJModel.seatid;
        var score = this.ackGameEnd.Score[seatId];
        var effectName = "lose";
        if (score > 0) {
            effectName = "win";
        }
        this._win_effect(effectName);

        var size = cc.director.getWinSize();
        var LayerBg = new cc.LayerColor(cc.color(0, 0, 0, 200));
        LayerBg.setContentSize(cc.size(size.width, size.height));
        LayerBg.setAnchorPoint(cc.p(0, 0));
        LayerBg.setPosition(cc.p(0, 0));
        this.addChild(LayerBg, -2);

        var itemHeight = 120;

        var count = 0;
        for (var m = 0; m < 4; m++) {
            var pos = m - 1 < 0 ? 3 : m - 1;

            var countY = m;

            if (MJModel.mj_roomType == 1) {
                if (pos == 2) {
                    continue;
                }
            }

            if (MJModel.mj_roomType == 2) {
                if (pos == 1 || pos == 3) {
                    continue;
                }

                if (pos == 0) {
                    countY = 1;
                } else if (pos == 2) {
                    countY = 2;
                }
            }

            var seatid = MJModel.getSeatidByPos(pos);

            var startY = 495 - count * itemHeight;
            var startX = 40;

            //头像
            var headLayer = this.createAvatar(pos);
            headLayer.setPosition(cc.p(startX + 60, startY + 55));
            this.bgSpr.addChild(headLayer, 10);

            //上排牌 杠
            var ganghuLayer = this.createGangHuLayer(seatid);
            this.bgSpr.addChild(ganghuLayer, 10);
            ganghuLayer.setPosition(cc.p(startX + 230, startY + 65));

            //下排牌
            var handCardLayer = this.createHandCard(seatid);
            handCardLayer.setPosition(cc.p(startX + 0, startY));
            this.bgSpr.addChild(handCardLayer);

            this.createSpecialHuTip(startX + 785, startY + 40, seatid);
            //this.createSpecialHuTip(startX + 900, startY + 40, seatid);

            // 输赢分
            var scoreLayer = this.createScoreLayer(seatid);
            scoreLayer.setPosition(cc.p(startX + 1100, startY + 40));
            this.bgSpr.addChild(scoreLayer);

            //中马列表
            var maLayer = this.createMaLayer(seatid);
            if (maLayer) {
                maLayer.setPosition(cc.p(startX + 845, startY + 85));
                this.bgSpr.addChild(maLayer);
            }
            count++;
        }
    },

    createAvatar: function (pos) {
        var layer = this._super(pos);
        var seatid = MJModel.getSeatidByPos(pos);
        if (this.ackGameEndJS.endinfo.length > seatid && this.ackGameEndJS.endinfo[seatid].baoting == 1) {
            var headSize = cc.size(96, 96);
            var baotingPic = new cc.Sprite(getResPath("gaoyoumj/gaoyou/ting_tip.png"));
            baotingPic.setAnchorPoint(cc.p(0.5, 0));
            baotingPic.setPosition(cc.p(headSize.width / 2, 0));
            layer.addChild(baotingPic, 100);
        }
        return layer;
    },

    createMaLayer: function (seatid) {
        var layer = new cc.Layer();
        //var startX = 0;
        //var startY = 15 - 60;
        //for (var i = 0; i < 20; i++) {
        //    var card = new MJCard();
        //    card.setValue(0x01, 0, CardType.Card_End, 0);
        //    card.setAnchorPoint(cc.p(0.0, 1));
        //    card.setScale(0.30);
        //    var di = i % 9;
        //    var dj = parseInt(i / 9);
        //    card.setPosition(cc.p(startX + di * card.getBoundingBox().width, startY + dj * (card.getBoundingBox().height - 5)));
        //    layer.addChild(card,20 - i);
        //}
        if (this.ackGameEndJS.hualist.length > seatid) {
            var HuaCards = this.ackGameEndJS.hualist[seatid].card;
            if (HuaCards.length > 0) {
                var startX = 0;
                var startY = 15 - 60;
                var length = HuaCards.length;
                for (var i = 0; i < length; i++) {
                    var card = new MJCard();
                    card.setValue(HuaCards[i], 0, CardType.Card_End, 0);
                    card.setAnchorPoint(cc.p(0.0, 1));
                    card.setScale(0.30);
                    var di = i % 9;
                    var dj = parseInt(i / 9);
                    card.setPosition(cc.p(startX + di * card.getBoundingBox().width, startY + dj * (card.getBoundingBox().height - 5)));
                    layer.addChild(card, 20 - i);
                }
            }
        }
        return layer;
    },

    createGangHuLayer: function (seatid) {
        var layer = new cc.Layer();
        var x = 0;
        var y = 0;
        var addFanType = [];
        if (this.ackGameEnd.faninfo.length > seatid) {
            var specialType = this.ackGameEnd.faninfo[seatid].SpecialType;
            switch (specialType) {
                case HuType.HU_ZIMO:
                case HuType.HU_PAOHU:
                case HuType.HU_QIANG_GANG:
                case HuType.HU_GANG_SHANG_HUA:
                    var addfan = this.ackGameEnd.faninfo[seatid].addfan;
                    for (var i = 0; i < addfan.length; i++) {
                        var add_fan = addfan[i];
                        var add_type = add_fan.AddType;
                        var add_value = add_fan.AddNum;
                        if (AddFanTypeArray[add_type]) {
                            if (add_type == 16) {
                                addFanType.push(AddFanTypeArray[add_type] + " x" + 2);
                            } else {
                                addFanType.push(AddFanTypeArray[add_type]);
                            }
                        }
                    }
                    break;

            }
        }

        if (this.ackGameEnd.UserCard.length > seatid) {
            var minggang = 0;
            var angang = 0;
            for (var i = 0; i < this.ackGameEnd.UserCard[seatid].FixedCardsLen; i++) {

                var state = this.ackGameEnd.UserCard[seatid].stFixedCards[i].state;
                var card = this.ackGameEnd.UserCard[seatid].stFixedCards[i].CardData;
                var chairID = this.ackGameEnd.UserCard[seatid].stFixedCards[i].chairID;
                var out_pos = MJModel.getPosBySeatid(chairID);

                if (card == undefined || card == null || card == 0) {
                    continue;
                }
                if ((state & ActionType.TYPE_ANGANG) == ActionType.TYPE_ANGANG) {
                    angang++;
                }

                if ((state & ActionType.TYPE_ZHIGANG) == ActionType.TYPE_ZHIGANG || (state & ActionType.TYPE_WANGANG) == ActionType.TYPE_WANGANG) {
                    minggang++;
                }
            }

            if (minggang > 0) {
                addFanType.push("明杠x" + minggang);
            }

            if (angang > 0) {
                addFanType.push("暗杠x" + angang);
            }
        }

        if (this.ackGameEndJS.endinfo.length > seatid) {
            var baotingfen = this.ackGameEndJS.endinfo[seatid].baotingscore;
            if (baotingfen != null && baotingfen != 0) {
                addFanType.push("报听分 " + (baotingfen > 0 ? ("+" + baotingfen) : baotingfen));
            }
            var xifen = this.ackGameEndJS.endinfo[seatid].xiscore;
            if (xifen != null && xifen != 0) {
                addFanType.push("喜分" + (xifen > 0 ? ("+" + xifen) : xifen));
            }

            var xiaoxinum = this.ackGameEndJS.endinfo[seatid].xiaoxinum;
            if (xiaoxinum != null && xiaoxinum != 0) {
                addFanType.push("小喜x" + xiaoxinum);
            }

            var daxinum = this.ackGameEndJS.endinfo[seatid].daxinum;
            if (daxinum != null && daxinum != 0) {
                addFanType.push("大喜x" + daxinum);
            }

            var yizhihuanum = this.ackGameEndJS.endinfo[seatid].yizhihuanum;
            if (yizhihuanum != null && yizhihuanum != 0) {
                addFanType.push(yizhihuanum + "枝花");
            }
        }

        if (this.ackGameEndJS.hualist.length > seatid) {
            var HuaCards = this.ackGameEndJS.hualist[seatid].card;
            if (HuaCards.length > 0) {
                addFanType.push("花牌x" + HuaCards.length);
            }
        }

        for (var i = 0; i < addFanType.length; i++) {
            var fanType = new cc.LabelTTF(addFanType[i], "Arial", 20);
            fanType.setColor(this.leftColor);
            fanType.setAnchorPoint(cc.p(0, 0));
            fanType.setPosition(cc.p(x, y + 10));
            layer.addChild(fanType);
            x += fanType.getContentSize().width + 5;
        }
        return layer;
    },

    createSpecialHuTip: function (startX, startY, seatid) {
        if (this.ackGameEnd.faninfo.length > seatid) {
            //胡牌类型
            var fanInfo = this.ackGameEnd.faninfo[seatid];
            var path = "";
            var ss = 1;
            //1表示自摸，2表示点炮胡，3表示放炮,4 被自摸 5天和 6地和 7抢杠胡 8杠上开花 9花上添花
            switch (fanInfo.SpecialType) {
                case 1:
                    path = "RoomMJ/result2/zi_mo_icon.png";
                    break;
                case 2:
                    path = "RoomMJ/result2/pao_hu_icon.png";
                    break;
                case 3:
                    path = "RoomMJ/result2/dian_pao_icon.png";
                    break;
                case 5:
                    path = "RoomMJ/result2/qiang_gang_icon.png";
                    ss = 0.8;
                    break;
                case 7:
                    path = "RoomMJ/result2/dian_pao_icon.png";
                    break;
                default:
                    break;
            }
            if (path != "") {
                var typeSprite = new cc.Sprite(getResPath(path));
                typeSprite.setPosition(cc.p(startX, startY));
                typeSprite.setScale(ss);
                this.bgSpr.addChild(typeSprite);

            }
        }
    },
    //输赢分
    createScoreLayer: function (seatid) {
        var layer = new cc.Layer();
        var score = 0;
        if (this.ackGameEnd.Score && this.ackGameEnd.Score.length > seatid) score = this.ackGameEnd.Score[seatid];
        var width = 0;
        var path = getResPath("RoomMJ/result2/result_small_label_lose.png");
        if (score > 0) {
            path = getResPath("RoomMJ/result2/result_small_label_win.png");
        }
        var scoredes = ":";
        if (score == 0) scoredes = "";
        var scoreLabel = new cc.LabelAtlas(scoredes + Math.abs(score), path, 29, 37, '0');

        scoreLabel.setAnchorPoint(cc.p(0.0, 0.5));

        scoreLabel.setPosition(cc.p(width, 15));
        scoreLabel.setName("scoreLabel");
        layer.addChild(scoreLabel);

        if (Math.abs(score) >= 10000) {
            scoreLabel.setScale(0.8);
        }
        return layer;
    },
});

var sendQuxiaoTuoguan = function () {
    var packet = createPacket("proto.game.gaoyoumj.ReqRobot");
    packet.robot = 0;
    sendPacket(packet, selfCMD.CLIENT_ROBOT_REQ);
}

